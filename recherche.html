<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Histoire d'Auterive — Recherche</title>
  <link rel="stylesheet" href="style.css" />
</head>
<body>
<header>
  <span class="site-author">Jean Marc DAVID</span>
  <h1>Histoire d'Auterive</h1>
</header>

<main>
  <section class="recherche-section">
    <h2>Recherche de notices</h2>

    <!-- Cadre blanc des 4 cases -->
    <div class="search-form">
      <div class="col-min-220" style="display:flex;flex-direction:column;">
        <label for="categorie">Catégorie</label>
        <select id="categorie">
          <option value="">— choisir —</option>
        </select>
      </div>

      <div class="col-min-220" style="display:flex;flex-direction:column;">
        <label for="objet">Objet</label>
        <select id="objet">
          <option value="">— choisir —</option>
        </select>
      </div>

      <div class="col-min-220" style="display:flex;flex-direction:column;">
        <label for="auteur">Auteur</label>
        <select id="auteur">
          <option value="">— choisir —</option>
        </select>
      </div>

      <div class="col-min-260" style="display:flex;flex-direction:column;">
        <label for="mot">Rechercher par mot du titre</label>
        <input type="text" id="mot" placeholder="Saisir un mot clé" />
      </div>
    </div>

    <!-- Ligne RAZ + lien contact -->
    <div class="actions-raz" style="position:relative;">
      <button id="resetBtn" class="btn" type="button">RAZ</button>
      <a href="contact.html" style="position:absolute; right:0; top:50%; transform:translateY(-50%);">Contact / Contribuer</a>
    </div>

    <!-- Compteur -->
    <div id="counter" class="counter">Résultats : 0 notice(s) trouvée(s)</div>

    <!-- Résultats -->
    <div id="results" class="results-box"></div>

    <!-- Diagnostic -->
    <div id="diag"></div>
  </section>
</main>

<footer>
  <p>&copy; 2025 Histoire d'Auterive · <span id="pv-counter">—</span> <span id="pv-badge" title="État du compteur"></span></p>
</footer>

<!-- JSON embarqué (fallback) -->
<script id="listing-json" type="application/json">
[
]
</script>

<script>
  // ===== Sélecteurs utiles =====
  const selCat  = () => document.getElementById("categorie");
  const selObj  = () => document.getElementById("objet");
  const selAut  = () => document.getElementById("auteur");
  const inpMot  = () => document.getElementById("mot");
  const resBox  = () => document.getElementById("results");
  const counter = () => document.getElementById("counter");
  const diagEl  = () => document.getElementById("diag");

  let notices = [];

  async function loadData(){
    try {
      const resp = await fetch('listing.json?ts=' + Date.now(), { cache: 'no-store' });
      if (resp.ok) {
        const data = await resp.json();
        if (Array.isArray(data) && data.length) return data;
      }
    } catch(e) { }
    try {
      const raw = document.getElementById("listing-json").textContent;
      const data = JSON.parse(raw);
      return Array.isArray(data) ? data : [];
    } catch(e) {
      return [];
    }
  }

  const norm = s => (s||"").toString().trim().toLowerCase();
  const sortFr = arr => [...arr].sort((a,b)=>a.localeCompare(b,"fr",{sensitivity:"base"}));

  function getField(n, key) {
    if (!n) return "";
    if (n[key] != null) return String(n[key]);
    const map = {
      "Categorie": ["Catégorie","Catégories","Categorie "],
      "Objet":     ["Objets","Objet "],
      "Auteur":    ["Auteurs","Auteur "],
      "Titre":     ["Titre "],
      "Fichier":   ["Fichier ","Lien","URL"]
    };
    const alts = map[key] || [];
    for (const k of alts) if (n[k] != null) return String(n[k]);
    return "";
  }

  function uniqueValuesFor(list, key){
    const set = new Set();
    for (const n of list){
      const v = getField(n, key).trim();
      if (v) set.add(v);
    }
    return sortFr([...set]);
  }

  function fillSelect(sel, values, current=""){
    sel.innerHTML = "";
    const opt0 = document.createElement("option");
    opt0.value = "";
    opt0.textContent = "— choisir —";
    sel.appendChild(opt0);

    let keep = false;
    for (const v of values){
      const opt = document.createElement("option");
      opt.value = v;
      opt.textContent = v;
      if (v === current){ opt.selected = true; keep = true; }
      sel.appendChild(opt);
    }
    if (!keep && current && values.length) sel.value = "";
  }

  function populateSelects(universe){
    const c = selCat().value, o = selObj().value, a = selAut().value;
    fillSelect(selCat(), uniqueValuesFor(universe,"Categorie"), c);
    fillSelect(selObj(), uniqueValuesFor(universe,"Objet"),     o);
    fillSelect(selAut(), uniqueValuesFor(universe,"Auteur"),    a);
  }

  function getNoticeUrl(n){
    const url = (getField(n,"Fichier") || "").trim();
    if (!url) return "";
    if (/^https?:\/\//i.test(url)) return url;
    if (/^[a-zA-Z]:\\/.test(url) || url.startsWith("\\\\")) return "";
    return "Source/" + url.replace(/^Source[\\/]/i,"");
  }

  function filterAll(base=notices){
    const c = selCat().value;
    const o = selObj().value;
    const a = selAut().value;
    const m = norm(inpMot().value);
    return base.filter(n=>{
      const tC = getField(n,"Categorie").trim();
      const tO = getField(n,"Objet").trim();
      const tA = getField(n,"Auteur").trim();
      const tT = norm(getField(n,"Titre"));
      const okC = !c || tC === c;
      const okO = !o || tO === o;
      const okA = !a || tA === a;
      const okM = !m || tT.includes(m);
      return okC && okO && okA && okM;
    });
  }

  // ==== Loader avec durée minimale + fondu ====
  let haLoaderStart = 0;
  const HA_MIN_MS = 1000;     // 1 seconde minimum visible
  const HA_FADE_MS = 300;     // 0,3 s de fondu

  function haShowLoader(msg){
    haLoaderStart = Date.now();
    const el = document.getElementById('ha-loader');
    const txt = document.getElementById('ha-msg');
    if (txt) txt.textContent = msg || 'Ouverture de la notice…';
    if (!el) return;
    el.style.display = 'grid';
    requestAnimationFrame(()=>{ el.style.opacity = '1'; el.style.pointerEvents = 'auto'; });
  }

  function haHideLoader(){
    const el = document.getElementById('ha-loader');
    if (!el) return;
    const elapsed = Date.now() - haLoaderStart;
    const wait = Math.max(0, HA_MIN_MS - elapsed);
    setTimeout(()=>{
      el.style.opacity = '0';
      el.style.pointerEvents = 'none';
      setTimeout(()=>{ el.style.display = 'none'; }, HA_FADE_MS);
    }, wait);
  }

  // On cache le loader quand on revient sur l'onglet
  window.addEventListener('focus', haHideLoader);
  document.addEventListener('visibilitychange', ()=>{
    if (document.visibilityState === 'visible') haHideLoader();
  });

  // Réveil discret : on n'affiche JAMAIS d'alerte, on tente juste une requête "no-cors"
  async function warmupSilent(url){
    try {
      // Beaucoup d'hébergements bloquent HEAD/CORS.
      // 'no-cors' renvoie une réponse "opaque" mais suffit à chauffer le cache.
      await fetch(url, { method:'HEAD', mode:'no-cors' });
    } catch(e){
      // On ignore les erreurs : l'ouverture directe fonctionne de toute façon.
    }
  }

  function drawResults(){
    const filtered = filterAll();
    populateSelects(filtered);
    const n = filtered.length;
    counter().textContent = `Résultats : ${n} notice(s) trouvée(s)`;

    const box = resBox();
    box.innerHTML = "";

    if (!filtered.length){
      box.innerHTML = "<p>Aucune notice trouvée</p>";
      return;
    }

    filtered.forEach(n=>{
      const p = document.createElement("p");
      p.textContent = getField(n,"Titre") || "(Sans titre)";

      const url = getNoticeUrl(n);
      p.addEventListener("click", async ()=>{
        if (!url){
          alert("Aucun lien disponible pour cette notice.");
          return;
        }
        haShowLoader('Préparation du document…');
        // On tente un réveil silencieux (sans bloquer l'ouverture du PDF)
        warmupSilent(url);
        // On ouvre immédiatement dans un nouvel onglet
        window.open(url, "_blank", "noopener");
        // Le loader se fermera automatiquement quand vous reviendrez sur la page
      });

      box.appendChild(p);
    });
  }

  function attach(){
    selCat().addEventListener("mousedown", ()=>{ if (selCat().options.length<=1)  populateSelects(notices); });
    selObj().addEventListener("mousedown", ()=>{ if (selObj().options.length<=1)  populateSelects(notices); });
    selAut().addEventListener("mousedown", ()=>{ if (selAut().options.length<=1)  populateSelects(notices); });

    selCat().addEventListener("change", drawResults);
    selObj().addEventListener("change", drawResults);
    selAut().addEventListener("change", drawResults);
    inpMot().addEventListener("input", drawResults);

    document.getElementById("resetBtn").addEventListener("click", ()=>{
      selCat().value = "";
      selObj().value = "";
      selAut().value = "";
      inpMot().value = "";
      populateSelects(notices);
      drawResults();
    });
  }

  (async function init(){
    notices = await loadData();
    populateSelects(notices);
    attach();
    drawResults();

    const dC = uniqueValuesFor(notices,"Categorie").length;
    const dO = uniqueValuesFor(notices,"Objet").length;
    const dA = uniqueValuesFor(notices,"Auteur").length;
    diagEl().textContent = `Diagnostic : ${notices.length} notices | Catégories : ${dC} | Objets : ${dO} | Auteurs : ${dA}`;
  })();
</script>

<!-- Compteur de visites (page: recherche) -->
<script>
(function(){
  const el = document.getElementById('pv-counter');
  const badge = document.getElementById('pv-badge');
  if(!el || !badge) return;

  const NS   = 'histoire-auterive.netlify.app';
  const KEY  = 'recherche';
  const LS   = 'pv-'+KEY;

  function show(val, online){
    el.textContent = (typeof val === 'number') ? val.toLocaleString('fr-FR') : '—';
    badge.textContent = online ? '[✓]' : '[~]';
  }
  function withTimeout(p, ms){
    return Promise.race([ p, new Promise((_,rej)=>setTimeout(()=>rej(new Error('timeout')), ms)) ]);
  }
  function localFallback(){
    let v = parseInt(localStorage.getItem(LS)||'0',10);
    v = isNaN(v) ? 1 : v+1;
    localStorage.setItem(LS, String(v));
    show(v, false);
  }

  const url1 = 'https://api.countapi.xyz/hit/'+encodeURIComponent(NS)+'/'+encodeURIComponent(KEY);
  withTimeout(fetch(url1, {cache:'no-store'}), 1500)
    .then(r=>r.json())
    .then(d=>{
      if(d && typeof d.value === 'number'){ show(d.value, true); }
      else throw new Error('no value from countapi');
    })
    .catch(()=>{
      const url2 = 'https://api.counterapi.dev/v1/'+encodeURIComponent(NS)+'/'+encodeURIComponent(KEY)+'/up';
      return withTimeout(fetch(url2, {cache:'no-store'}), 1500)
        .then(r=>r.json())
        .then(d=>{
          if(d && typeof d.count === 'number'){ show(d.count, true); }
          else throw new Error('no value from counterapi');
        })
        .catch(localFallback);
    });
})();
</script>

<!-- Écran d’attente (masque) -->
<div id="ha-loader" style="
  position:fixed;
  inset:0;
  display:none;
  place-items:center;
  background:#fff;
  z-index:9999;
  opacity:0;
  transition:opacity .3s ease;
  pointer-events:none;
">
  <div style="width:min(92vw,420px);font-family:system-ui,Segoe UI,Roboto,Arial;">
    <p id="ha-msg" style="margin:0 0 10px 0;text-align:center;font-weight:600">Ouverture de la notice…</p>
    <div style="height:10px;border-radius:999px;background:#eee;overflow:hidden;">
      <div id="ha-bar" style="height:100%;width:30%;background:#68a;transform:translateX(-30%);animation:haSlide 1.2s ease-in-out infinite;"></div>
    </div>
    <p style="margin:10px 0 0 0;text-align:center;color:#666;font-size:14px">Merci de patienter</p>
  </div>
</div>

<style>
@keyframes haSlide {
  0%   { transform:translateX(-30%); }
  50%  { transform:translateX(100%); }
  100% { transform:translateX(-30%); }
}
</style>

</body>
</html>

